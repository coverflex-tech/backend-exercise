  [1m[35m (0.8ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[35m (0.3ms)[0m  [1m[34mSELECT "ar_internal_metadata"."value" FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = $1[0m  [["key", "environment"]]
  [1m[35m (0.1ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[35m (0.2ms)[0m  [1m[34mSELECT "ar_internal_metadata"."value" FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = $1[0m  [["key", "environment"]]
  [1m[35m (0.1ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[35m (0.2ms)[0m  [1m[34mSELECT "ar_internal_metadata"."value" FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = $1[0m  [["key", "environment"]]
  [1m[35m (1144.4ms)[0m  [1m[35mDROP DATABASE IF EXISTS "coverflex_development"[0m
  [1m[35m (34.0ms)[0m  [1m[35mDROP DATABASE IF EXISTS "coverflex_test"[0m
  [1m[35m (113.8ms)[0m  [1m[35mCREATE DATABASE "coverflex_development" ENCODING = 'unicode'[0m
  [1m[35m (48.7ms)[0m  [1m[35mCREATE DATABASE "coverflex_test" ENCODING = 'unicode'[0m
  [1m[35m (4.0ms)[0m  [1m[35mCREATE TABLE "schema_migrations" ("version" character varying NOT NULL PRIMARY KEY)[0m
  [1m[35m (1.8ms)[0m  [1m[35mCREATE TABLE "ar_internal_metadata" ("key" character varying NOT NULL PRIMARY KEY, "value" character varying, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[35m (0.1ms)[0m  [1m[34mSELECT pg_try_advisory_lock(2073526805391686085)[0m
  [1m[35m (0.3ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
Migrating to CreateUsers (20200209145203)
  [1m[35m (0.1ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (2.5ms)[0m  [1m[35mCREATE TABLE "users" ("id" bigserial primary key, "username" character varying NOT NULL, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[35m (0.7ms)[0m  [1m[35mCREATE  INDEX  "index_users_on_username" ON "users"  ("username")[0m
  [1m[36mprimary::SchemaMigration Create (0.3ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ($1) RETURNING "version"[0m  [["version", "20200209145203"]]
  [1m[35m (0.4ms)[0m  [1m[35mCOMMIT[0m
Migrating to CreateProducts (20200209182154)
  [1m[35m (0.2ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (2.1ms)[0m  [1m[35mCREATE TABLE "products" ("id" bigserial primary key, "code" character varying, "name" character varying, "price" float, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[35m (0.6ms)[0m  [1m[35mCREATE  INDEX  "index_products_on_code" ON "products"  ("code")[0m
  [1m[36mprimary::SchemaMigration Create (0.2ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ($1) RETURNING "version"[0m  [["version", "20200209182154"]]
  [1m[35m (0.3ms)[0m  [1m[35mCOMMIT[0m
Migrating to CreateBalances (20200209193540)
  [1m[35m (0.2ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (1.4ms)[0m  [1m[35mCREATE TABLE "balances" ("id" bigserial primary key, "user_id" integer, "amount" float, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL)[0m
  [1m[35m (1.0ms)[0m  [1m[35mCREATE  INDEX  "index_balances_on_user_id" ON "balances"  ("user_id")[0m
  [1m[36mprimary::SchemaMigration Create (0.1ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ($1) RETURNING "version"[0m  [["version", "20200209193540"]]
  [1m[35m (0.2ms)[0m  [1m[35mCOMMIT[0m
Migrating to CreateOrders (20200209202829)
  [1m[35m (0.2ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (2.2ms)[0m  [1m[35mCREATE TABLE "orders" ("id" bigserial primary key, "user_id" bigint NOT NULL, "total" float, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, CONSTRAINT "fk_rails_f868b47f6a"
FOREIGN KEY ("user_id")
  REFERENCES "users" ("id")
)[0m
  [1m[35m (0.5ms)[0m  [1m[35mCREATE  INDEX  "index_orders_on_user_id" ON "orders"  ("user_id")[0m
  [1m[35m (0.5ms)[0m  [1m[35mCREATE  INDEX  "index_orders_on_id" ON "orders"  ("id")[0m
  [1m[36mprimary::SchemaMigration Create (0.1ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ($1) RETURNING "version"[0m  [["version", "20200209202829"]]
  [1m[35m (0.2ms)[0m  [1m[35mCOMMIT[0m
Migrating to CreatePurchaseds (20200209210114)
  [1m[35m (0.1ms)[0m  [1m[35mBEGIN[0m
  [1m[35m (1.9ms)[0m  [1m[35mCREATE TABLE "purchaseds" ("id" bigserial primary key, "order_id" bigint NOT NULL, "product_id" bigint NOT NULL, "created_at" timestamp(6) NOT NULL, "updated_at" timestamp(6) NOT NULL, CONSTRAINT "fk_rails_622548a1de"
FOREIGN KEY ("order_id")
  REFERENCES "orders" ("id")
, CONSTRAINT "fk_rails_dee259c3dd"
FOREIGN KEY ("product_id")
  REFERENCES "products" ("id")
)[0m
  [1m[35m (0.6ms)[0m  [1m[35mCREATE  INDEX  "index_purchaseds_on_order_id" ON "purchaseds"  ("order_id")[0m
  [1m[35m (0.6ms)[0m  [1m[35mCREATE  INDEX  "index_purchaseds_on_product_id" ON "purchaseds"  ("product_id")[0m
  [1m[36mprimary::SchemaMigration Create (0.2ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ($1) RETURNING "version"[0m  [["version", "20200209210114"]]
  [1m[35m (0.2ms)[0m  [1m[35mCOMMIT[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.3ms)[0m  [1m[34mSELECT "ar_internal_metadata".* FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = $1 LIMIT $2[0m  [["key", "environment"], ["LIMIT", 1]]
  [1m[35m (0.2ms)[0m  [1m[35mBEGIN[0m
  [1m[36mActiveRecord::InternalMetadata Create (0.4ms)[0m  [1m[32mINSERT INTO "ar_internal_metadata" ("key", "value", "created_at", "updated_at") VALUES ($1, $2, $3, $4) RETURNING "key"[0m  [["key", "environment"], ["value", "development"], ["created_at", "2020-02-09 23:45:22.985080"], ["updated_at", "2020-02-09 23:45:22.985080"]]
  [1m[35m (0.3ms)[0m  [1m[35mCOMMIT[0m
  [1m[35m (0.2ms)[0m  [1m[34mSELECT pg_advisory_unlock(2073526805391686085)[0m
  [1m[35m (0.7ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[35m (0.6ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[35m (0.1ms)[0m  [1m[35mBEGIN[0m
  [1m[36mProduct Exists? (0.8ms)[0m  [1m[34mSELECT 1 AS one FROM "products" WHERE "products"."code" = $1 LIMIT $2[0m  [["code", "netflix"], ["LIMIT", 1]]
  [1m[36mProduct Create (0.8ms)[0m  [1m[32mINSERT INTO "products" ("code", "name", "price", "created_at", "updated_at") VALUES ($1, $2, $3, $4, $5) RETURNING "id"[0m  [["code", "netflix"], ["name", "Netflix"], ["price", 73.0], ["created_at", "2020-02-09 23:45:23.093660"], ["updated_at", "2020-02-09 23:45:23.093660"]]
  [1m[35m (0.4ms)[0m  [1m[35mCOMMIT[0m
  [1m[35m (0.1ms)[0m  [1m[35mBEGIN[0m
  [1m[36mProduct Exists? (0.3ms)[0m  [1m[34mSELECT 1 AS one FROM "products" WHERE "products"."code" = $1 LIMIT $2[0m  [["code", "apple"], ["LIMIT", 1]]
  [1m[36mProduct Create (0.4ms)[0m  [1m[32mINSERT INTO "products" ("code", "name", "price", "created_at", "updated_at") VALUES ($1, $2, $3, $4, $5) RETURNING "id"[0m  [["code", "apple"], ["name", "Apple TV"], ["price", 81.0], ["created_at", "2020-02-09 23:45:23.100247"], ["updated_at", "2020-02-09 23:45:23.100247"]]
  [1m[35m (0.8ms)[0m  [1m[35mCOMMIT[0m
  [1m[35m (0.7ms)[0m  [1m[35mBEGIN[0m
  [1m[36mProduct Exists? (3.4ms)[0m  [1m[34mSELECT 1 AS one FROM "products" WHERE "products"."code" = $1 LIMIT $2[0m  [["code", "hbo"], ["LIMIT", 1]]
  [1m[36mProduct Create (0.3ms)[0m  [1m[32mINSERT INTO "products" ("code", "name", "price", "created_at", "updated_at") VALUES ($1, $2, $3, $4, $5) RETURNING "id"[0m  [["code", "hbo"], ["name", "HBO Go"], ["price", 30.0], ["created_at", "2020-02-09 23:45:23.110823"], ["updated_at", "2020-02-09 23:45:23.110823"]]
  [1m[35m (0.3ms)[0m  [1m[35mCOMMIT[0m
  [1m[35m (0.1ms)[0m  [1m[35mBEGIN[0m
  [1m[36mProduct Exists? (0.2ms)[0m  [1m[34mSELECT 1 AS one FROM "products" WHERE "products"."code" = $1 LIMIT $2[0m  [["code", "crackle"], ["LIMIT", 1]]
  [1m[36mProduct Create (0.3ms)[0m  [1m[32mINSERT INTO "products" ("code", "name", "price", "created_at", "updated_at") VALUES ($1, $2, $3, $4, $5) RETURNING "id"[0m  [["code", "crackle"], ["name", "Crackle"], ["price", 66.0], ["created_at", "2020-02-09 23:45:23.115512"], ["updated_at", "2020-02-09 23:45:23.115512"]]
  [1m[35m (0.2ms)[0m  [1m[35mCOMMIT[0m
  [1m[35m (0.1ms)[0m  [1m[35mBEGIN[0m
  [1m[36mProduct Exists? (0.2ms)[0m  [1m[34mSELECT 1 AS one FROM "products" WHERE "products"."code" = $1 LIMIT $2[0m  [["code", "looke"], ["LIMIT", 1]]
  [1m[36mProduct Create (0.2ms)[0m  [1m[32mINSERT INTO "products" ("code", "name", "price", "created_at", "updated_at") VALUES ($1, $2, $3, $4, $5) RETURNING "id"[0m  [["code", "looke"], ["name", "Looke"], ["price", 18.0], ["created_at", "2020-02-09 23:45:23.119164"], ["updated_at", "2020-02-09 23:45:23.119164"]]
  [1m[35m (0.2ms)[0m  [1m[35mCOMMIT[0m
  [1m[35m (0.2ms)[0m  [1m[35mBEGIN[0m
  [1m[36mProduct Exists? (0.3ms)[0m  [1m[34mSELECT 1 AS one FROM "products" WHERE "products"."code" = $1 LIMIT $2[0m  [["code", "mubi"], ["LIMIT", 1]]
  [1m[36mProduct Create (0.4ms)[0m  [1m[32mINSERT INTO "products" ("code", "name", "price", "created_at", "updated_at") VALUES ($1, $2, $3, $4, $5) RETURNING "id"[0m  [["code", "mubi"], ["name", "Mubi"], ["price", 42.0], ["created_at", "2020-02-09 23:45:23.141364"], ["updated_at", "2020-02-09 23:45:23.141364"]]
  [1m[35m (0.5ms)[0m  [1m[35mCOMMIT[0m
  [1m[35m (0.2ms)[0m  [1m[35mBEGIN[0m
  [1m[36mProduct Exists? (0.3ms)[0m  [1m[34mSELECT 1 AS one FROM "products" WHERE "products"."code" = $1 LIMIT $2[0m  [["code", "net_movies"], ["LIMIT", 1]]
  [1m[36mProduct Create (0.3ms)[0m  [1m[32mINSERT INTO "products" ("code", "name", "price", "created_at", "updated_at") VALUES ($1, $2, $3, $4, $5) RETURNING "id"[0m  [["code", "net_movies"], ["name", "NetMovies"], ["price", 72.0], ["created_at", "2020-02-09 23:45:23.147928"], ["updated_at", "2020-02-09 23:45:23.147928"]]
  [1m[35m (0.3ms)[0m  [1m[35mCOMMIT[0m
  [1m[35m (0.1ms)[0m  [1m[35mBEGIN[0m
  [1m[36mProduct Exists? (0.3ms)[0m  [1m[34mSELECT 1 AS one FROM "products" WHERE "products"."code" = $1 LIMIT $2[0m  [["code", "google_play_store"], ["LIMIT", 1]]
  [1m[36mProduct Create (0.3ms)[0m  [1m[32mINSERT INTO "products" ("code", "name", "price", "created_at", "updated_at") VALUES ($1, $2, $3, $4, $5) RETURNING "id"[0m  [["code", "google_play_store"], ["name", "Google Play Store"], ["price", 87.0], ["created_at", "2020-02-09 23:45:23.153437"], ["updated_at", "2020-02-09 23:45:23.153437"]]
  [1m[35m (0.2ms)[0m  [1m[35mCOMMIT[0m
Started GET "/api/users/123" for ::1 at 2020-02-09 23:45:49 +0000
  [1m[35m (0.5ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
Processing by Api::UsersController#show as JSON
  Parameters: {"id"=>"123"}
  [1m[35m (0.1ms)[0m  [1m[35mBEGIN[0m
  ↳ app/services/user_find_or_create.rb:27:in `block in find_or_create_user'
  [1m[36mUser Load (1.2ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."username" = $1 LIMIT $2[0m  [["username", "123"], ["LIMIT", 1]]
  ↳ app/services/user_find_or_create.rb:27:in `block in find_or_create_user'
  [1m[36mUser Exists? (0.2ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."username" = $1 LIMIT $2[0m  [["username", "123"], ["LIMIT", 1]]
  ↳ app/services/user_find_or_create.rb:27:in `block in find_or_create_user'
  [1m[36mUser Create (0.5ms)[0m  [1m[32mINSERT INTO "users" ("username", "created_at", "updated_at") VALUES ($1, $2, $3) RETURNING "id"[0m  [["username", "123"], ["created_at", "2020-02-09 23:45:49.673099"], ["updated_at", "2020-02-09 23:45:49.673099"]]
  ↳ app/services/user_find_or_create.rb:27:in `block in find_or_create_user'
  [1m[36mBalance Create (1.1ms)[0m  [1m[32mINSERT INTO "balances" ("user_id", "amount", "created_at", "updated_at") VALUES ($1, $2, $3, $4) RETURNING "id"[0m  [["user_id", 1], ["amount", 500.0], ["created_at", "2020-02-09 23:45:49.694101"], ["updated_at", "2020-02-09 23:45:49.694101"]]
  ↳ app/models/user.rb:10:in `block in <class:User>'
  [1m[35m (0.5ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/services/user_find_or_create.rb:26:in `find_or_create_user'
  [1m[36mOrder Load (1.0ms)[0m  [1m[34mSELECT "orders".* FROM "orders" WHERE "orders"."user_id" = $1[0m  [["user_id", 1]]
  ↳ app/services/user_find_or_create.rb:35:in `user_products'
  [1m[35m (0.3ms)[0m  [1m[34mSELECT SUM("balances"."amount") FROM "balances" WHERE "balances"."user_id" = $1[0m  [["user_id", 1]]
  ↳ app/services/user_find_or_create.rb:43:in `return'
Completed 200 OK in 276ms (Views: 0.5ms | ActiveRecord: 11.8ms | Allocations: 222299)


Started GET "/api/products" for ::1 at 2020-02-09 23:45:49 +0000
Processing by Api::ProductsController#index as JSON
  [1m[36mProduct Load (0.7ms)[0m  [1m[34mSELECT "products".* FROM "products"[0m
  ↳ app/controllers/api/products_controller.rb:9:in `index'
Completed 200 OK in 15ms (Views: 9.3ms | ActiveRecord: 2.9ms | Allocations: 6791)


Started POST "/api/orders" for ::1 at 2020-02-09 23:45:52 +0000
Processing by Api::OrdersController#create as JSON
  Parameters: {"order"=>{"items"=>["hbo", "crackle"], "user_id"=>"123"}}
  [1m[36mUser Load (0.3ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."username" = $1 LIMIT $2[0m  [["username", "123"], ["LIMIT", 1]]
  ↳ app/services/order_create.rb:16:in `init'
  [1m[35m (0.6ms)[0m  [1m[34mSELECT SUM("products"."price") FROM "products" WHERE "products"."code" IN ($1, $2)[0m  [["code", "hbo"], ["code", "crackle"]]
  ↳ app/services/order_create.rb:18:in `init'
  [1m[36mProduct Load (0.4ms)[0m  [1m[34mSELECT "products".* FROM "products" WHERE "products"."code" IN ($1, $2)[0m  [["code", "hbo"], ["code", "crackle"]]
  ↳ app/services/order_create.rb:24:in `validate_data'
  [1m[35m (0.4ms)[0m  [1m[34mSELECT "products"."code" FROM "products"[0m
  ↳ app/services/order_create.rb:28:in `check_products_exists'
  [1m[36mOrder Load (0.2ms)[0m  [1m[34mSELECT "orders".* FROM "orders" WHERE "orders"."user_id" = $1[0m  [["user_id", 1]]
  ↳ app/services/order_create.rb:36:in `already_purchased'
  [1m[35m (0.3ms)[0m  [1m[34mSELECT SUM("balances"."amount") FROM "balances" WHERE "balances"."user_id" = $1[0m  [["user_id", 1]]
  ↳ app/services/order_create.rb:43:in `check_balance'
  [1m[35m (0.1ms)[0m  [1m[35mBEGIN[0m
  ↳ app/services/order_create.rb:48:in `block in create_order'
  [1m[36mOrder Create (0.7ms)[0m  [1m[32mINSERT INTO "orders" ("user_id", "total", "created_at", "updated_at") VALUES ($1, $2, $3, $4) RETURNING "id"[0m  [["user_id", 1], ["total", 96.0], ["created_at", "2020-02-09 23:45:52.203841"], ["updated_at", "2020-02-09 23:45:52.203841"]]
  ↳ app/services/order_create.rb:48:in `block in create_order'
  [1m[36mPurchased Create (2.3ms)[0m  [1m[32mINSERT INTO "purchaseds" ("order_id", "product_id", "created_at", "updated_at") VALUES ($1, $2, $3, $4) RETURNING "id"[0m  [["order_id", 1], ["product_id", 3], ["created_at", "2020-02-09 23:45:52.214126"], ["updated_at", "2020-02-09 23:45:52.214126"]]
  ↳ app/services/order_create.rb:50:in `block (2 levels) in create_order'
  [1m[36mPurchased Create (0.4ms)[0m  [1m[32mINSERT INTO "purchaseds" ("order_id", "product_id", "created_at", "updated_at") VALUES ($1, $2, $3, $4) RETURNING "id"[0m  [["order_id", 1], ["product_id", 4], ["created_at", "2020-02-09 23:45:52.218481"], ["updated_at", "2020-02-09 23:45:52.218481"]]
  ↳ app/services/order_create.rb:50:in `block (2 levels) in create_order'
  [1m[35m (0.3ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/services/order_create.rb:47:in `create_order'
Completed 200 OK in 36ms (Views: 0.2ms | ActiveRecord: 9.1ms | Allocations: 15180)


Started GET "/api/users/123" for ::1 at 2020-02-09 23:45:54 +0000
Processing by Api::UsersController#show as JSON
  Parameters: {"id"=>"123"}
  [1m[35m (0.2ms)[0m  [1m[35mBEGIN[0m
  ↳ app/services/user_find_or_create.rb:27:in `block in find_or_create_user'
  [1m[36mUser Load (0.3ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."username" = $1 LIMIT $2[0m  [["username", "123"], ["LIMIT", 1]]
  ↳ app/services/user_find_or_create.rb:27:in `block in find_or_create_user'
  [1m[35m (0.2ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/services/user_find_or_create.rb:26:in `find_or_create_user'
  [1m[36mOrder Load (0.2ms)[0m  [1m[34mSELECT "orders".* FROM "orders" WHERE "orders"."user_id" = $1[0m  [["user_id", 1]]
  ↳ app/services/user_find_or_create.rb:35:in `user_products'
  [1m[35m (0.3ms)[0m  [1m[34mSELECT "products"."code" FROM "products" INNER JOIN "purchaseds" ON "products"."id" = "purchaseds"."product_id" WHERE "purchaseds"."order_id" = $1[0m  [["order_id", 1]]
  ↳ app/services/user_find_or_create.rb:35:in `block in user_products'
  [1m[35m (0.2ms)[0m  [1m[34mSELECT SUM("balances"."amount") FROM "balances" WHERE "balances"."user_id" = $1[0m  [["user_id", 1]]
  ↳ app/services/user_find_or_create.rb:43:in `return'
Completed 200 OK in 12ms (Views: 0.2ms | ActiveRecord: 1.4ms | Allocations: 5382)


Started GET "/api/products" for ::1 at 2020-02-09 23:45:55 +0000
Processing by Api::ProductsController#index as JSON
  [1m[36mProduct Load (0.5ms)[0m  [1m[34mSELECT "products".* FROM "products"[0m
  ↳ app/controllers/api/products_controller.rb:9:in `index'
Completed 200 OK in 3ms (Views: 2.0ms | ActiveRecord: 0.5ms | Allocations: 1384)


Started GET "/api/users/4234" for ::1 at 2020-02-09 23:45:58 +0000
Processing by Api::UsersController#show as JSON
  Parameters: {"id"=>"4234"}
  [1m[35m (0.2ms)[0m  [1m[35mBEGIN[0m
  ↳ app/services/user_find_or_create.rb:27:in `block in find_or_create_user'
  [1m[36mUser Load (0.3ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."username" = $1 LIMIT $2[0m  [["username", "4234"], ["LIMIT", 1]]
  ↳ app/services/user_find_or_create.rb:27:in `block in find_or_create_user'
  [1m[36mUser Exists? (0.4ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."username" = $1 LIMIT $2[0m  [["username", "4234"], ["LIMIT", 1]]
  ↳ app/services/user_find_or_create.rb:27:in `block in find_or_create_user'
  [1m[36mUser Create (0.4ms)[0m  [1m[32mINSERT INTO "users" ("username", "created_at", "updated_at") VALUES ($1, $2, $3) RETURNING "id"[0m  [["username", "4234"], ["created_at", "2020-02-09 23:45:58.392691"], ["updated_at", "2020-02-09 23:45:58.392691"]]
  ↳ app/services/user_find_or_create.rb:27:in `block in find_or_create_user'
  [1m[36mBalance Create (0.4ms)[0m  [1m[32mINSERT INTO "balances" ("user_id", "amount", "created_at", "updated_at") VALUES ($1, $2, $3, $4) RETURNING "id"[0m  [["user_id", 2], ["amount", 500.0], ["created_at", "2020-02-09 23:45:58.395845"], ["updated_at", "2020-02-09 23:45:58.395845"]]
  ↳ app/models/user.rb:10:in `block in <class:User>'
  [1m[35m (0.3ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/services/user_find_or_create.rb:26:in `find_or_create_user'
  [1m[36mOrder Load (0.3ms)[0m  [1m[34mSELECT "orders".* FROM "orders" WHERE "orders"."user_id" = $1[0m  [["user_id", 2]]
  ↳ app/services/user_find_or_create.rb:35:in `user_products'
  [1m[35m (0.3ms)[0m  [1m[34mSELECT SUM("balances"."amount") FROM "balances" WHERE "balances"."user_id" = $1[0m  [["user_id", 2]]
  ↳ app/services/user_find_or_create.rb:43:in `return'
Completed 200 OK in 15ms (Views: 0.2ms | ActiveRecord: 2.5ms | Allocations: 6418)


Started GET "/api/products" for ::1 at 2020-02-09 23:45:58 +0000
Processing by Api::ProductsController#index as JSON
  [1m[36mProduct Load (0.2ms)[0m  [1m[34mSELECT "products".* FROM "products"[0m
  ↳ app/controllers/api/products_controller.rb:9:in `index'
Completed 200 OK in 2ms (Views: 1.5ms | ActiveRecord: 0.2ms | Allocations: 1384)


Started POST "/api/orders" for ::1 at 2020-02-09 23:46:00 +0000
Processing by Api::OrdersController#create as JSON
  Parameters: {"order"=>{"items"=>["crackle"], "user_id"=>"4234"}}
  [1m[36mUser Load (0.2ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."username" = $1 LIMIT $2[0m  [["username", "4234"], ["LIMIT", 1]]
  ↳ app/services/order_create.rb:16:in `init'
  [1m[35m (0.2ms)[0m  [1m[34mSELECT SUM("products"."price") FROM "products" WHERE "products"."code" = $1[0m  [["code", "crackle"]]
  ↳ app/services/order_create.rb:18:in `init'
  [1m[36mProduct Load (0.1ms)[0m  [1m[34mSELECT "products".* FROM "products" WHERE "products"."code" = $1[0m  [["code", "crackle"]]
  ↳ app/services/order_create.rb:24:in `validate_data'
  [1m[35m (0.2ms)[0m  [1m[34mSELECT "products"."code" FROM "products"[0m
  ↳ app/services/order_create.rb:28:in `check_products_exists'
  [1m[36mOrder Load (0.2ms)[0m  [1m[34mSELECT "orders".* FROM "orders" WHERE "orders"."user_id" = $1[0m  [["user_id", 2]]
  ↳ app/services/order_create.rb:36:in `already_purchased'
  [1m[35m (0.3ms)[0m  [1m[34mSELECT SUM("balances"."amount") FROM "balances" WHERE "balances"."user_id" = $1[0m  [["user_id", 2]]
  ↳ app/services/order_create.rb:43:in `check_balance'
  [1m[35m (0.1ms)[0m  [1m[35mBEGIN[0m
  ↳ app/services/order_create.rb:48:in `block in create_order'
  [1m[36mOrder Create (0.6ms)[0m  [1m[32mINSERT INTO "orders" ("user_id", "total", "created_at", "updated_at") VALUES ($1, $2, $3, $4) RETURNING "id"[0m  [["user_id", 2], ["total", 66.0], ["created_at", "2020-02-09 23:46:00.576198"], ["updated_at", "2020-02-09 23:46:00.576198"]]
  ↳ app/services/order_create.rb:48:in `block in create_order'
  [1m[36mPurchased Create (0.4ms)[0m  [1m[32mINSERT INTO "purchaseds" ("order_id", "product_id", "created_at", "updated_at") VALUES ($1, $2, $3, $4) RETURNING "id"[0m  [["order_id", 2], ["product_id", 4], ["created_at", "2020-02-09 23:46:00.580015"], ["updated_at", "2020-02-09 23:46:00.580015"]]
  ↳ app/services/order_create.rb:50:in `block (2 levels) in create_order'
  [1m[35m (0.4ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/services/order_create.rb:47:in `create_order'
Completed 200 OK in 13ms (Views: 0.2ms | ActiveRecord: 2.6ms | Allocations: 7005)


Started GET "/api/users/123" for ::1 at 2020-02-09 23:46:02 +0000
Processing by Api::UsersController#show as JSON
  Parameters: {"id"=>"123"}
  [1m[35m (0.1ms)[0m  [1m[35mBEGIN[0m
  ↳ app/services/user_find_or_create.rb:27:in `block in find_or_create_user'
  [1m[36mUser Load (1.0ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."username" = $1 LIMIT $2[0m  [["username", "123"], ["LIMIT", 1]]
  ↳ app/services/user_find_or_create.rb:27:in `block in find_or_create_user'
  [1m[35m (1.5ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/services/user_find_or_create.rb:26:in `find_or_create_user'
  [1m[36mOrder Load (0.4ms)[0m  [1m[34mSELECT "orders".* FROM "orders" WHERE "orders"."user_id" = $1[0m  [["user_id", 1]]
  ↳ app/services/user_find_or_create.rb:35:in `user_products'
  [1m[35m (0.4ms)[0m  [1m[34mSELECT "products"."code" FROM "products" INNER JOIN "purchaseds" ON "products"."id" = "purchaseds"."product_id" WHERE "purchaseds"."order_id" = $1[0m  [["order_id", 1]]
  ↳ app/services/user_find_or_create.rb:35:in `block in user_products'
  [1m[35m (1.3ms)[0m  [1m[34mSELECT SUM("balances"."amount") FROM "balances" WHERE "balances"."user_id" = $1[0m  [["user_id", 1]]
  ↳ app/services/user_find_or_create.rb:43:in `return'
Completed 200 OK in 12ms (Views: 0.2ms | ActiveRecord: 4.8ms | Allocations: 4195)


Started GET "/api/products" for ::1 at 2020-02-09 23:46:02 +0000
Processing by Api::ProductsController#index as JSON
  [1m[36mProduct Load (0.4ms)[0m  [1m[34mSELECT "products".* FROM "products"[0m
  ↳ app/controllers/api/products_controller.rb:9:in `index'
Completed 200 OK in 3ms (Views: 2.2ms | ActiveRecord: 0.4ms | Allocations: 1384)


Started GET "/api/users/4234" for ::1 at 2020-02-09 23:46:28 +0000
Processing by Api::UsersController#show as JSON
  Parameters: {"id"=>"4234"}
  [1m[35m (0.1ms)[0m  [1m[35mBEGIN[0m
  ↳ app/services/user_find_or_create.rb:27:in `block in find_or_create_user'
  [1m[36mUser Load (0.1ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."username" = $1 LIMIT $2[0m  [["username", "4234"], ["LIMIT", 1]]
  ↳ app/services/user_find_or_create.rb:27:in `block in find_or_create_user'
  [1m[35m (0.1ms)[0m  [1m[35mCOMMIT[0m
  ↳ app/services/user_find_or_create.rb:26:in `find_or_create_user'
  [1m[36mOrder Load (0.1ms)[0m  [1m[34mSELECT "orders".* FROM "orders" WHERE "orders"."user_id" = $1[0m  [["user_id", 2]]
  ↳ app/services/user_find_or_create.rb:35:in `user_products'
  [1m[35m (0.3ms)[0m  [1m[34mSELECT "products"."code" FROM "products" INNER JOIN "purchaseds" ON "products"."id" = "purchaseds"."product_id" WHERE "purchaseds"."order_id" = $1[0m  [["order_id", 2]]
  ↳ app/services/user_find_or_create.rb:35:in `block in user_products'
  [1m[35m (0.2ms)[0m  [1m[34mSELECT SUM("balances"."amount") FROM "balances" WHERE "balances"."user_id" = $1[0m  [["user_id", 2]]
  ↳ app/services/user_find_or_create.rb:43:in `return'
Completed 200 OK in 6ms (Views: 0.2ms | ActiveRecord: 1.0ms | Allocations: 4183)


Started GET "/api/products" for ::1 at 2020-02-09 23:46:28 +0000
Processing by Api::ProductsController#index as JSON
  [1m[36mProduct Load (0.2ms)[0m  [1m[34mSELECT "products".* FROM "products"[0m
  ↳ app/controllers/api/products_controller.rb:9:in `index'
Completed 200 OK in 2ms (Views: 1.7ms | ActiveRecord: 0.2ms | Allocations: 1384)


